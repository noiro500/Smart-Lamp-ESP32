# Контроллер лампы SmartLampESP32

Контроллер электронных устройств SmartLampESP32 представляет из себя устройство, которое может выполнять следующие действия:

*   Подключаться к сети WiFi в режиме WiFi\_STA (лампа подключается у точке доступа).
*   Выступать в режиме WiFi\_AP (лампа сама выступает в роли точки доступа).
*   Включать и выключать электрические приботы по команде.
*   Включать и выключать алектрические приботы по таймеру.
*   Измерять температуру и влажность.
*   Измерять и сохранять температуру и влажность в течении суток.
*   Получать время с сервера времени ntp.
*   Автоматически переподключаться к точке доступа WfFi при потере соединения.

В настоящий момент контроллер используется для контроля фитолампы.

## Подготовка к использованию

В проекте используются:

*   Плата ESP32 WeMos LOLIN32 Lite.
*   Цифровой датчик температуры и влажности Aosong AM2320.
*   Модуль реле для коммутации нагрузки 110/220 вольт

Подключить датчик AM2320 к соответствующим пинам платы микроконтроллера. Так как используется плата ESP32 WeMos LOLIN32 Lite, то это следующие пины: SDA - 19, SCL - 23 (для других плат ESP32 пины могут отличаться). Подключить питание к AM2320. Подключить модуль реле к соответствующи пинам (по умолчанию In или Sig к пину 23, пины питания VCC и GND)  

**Внимание:** если датчик AM2320 не передает показания, то, вероятно, в нем отсутствуют резисторы на выводах SDA и SCL.  Необходимо подключить резистор 10КОм параллельно выходу SDA и SCA AM2320 и плюсом питания VCC.

![ESP32 AM2320](Image//ConnectAM2320.png)

### Настройка прошивки

Откройте файл GeneralParameters.h и настройте параметры конфигурации по умолчанию:

```cpp
#define WIFI_MODE "WIFI_STA"                        // Режим работы ESP32 WiFi (WIFI_AP, WIFI_STA)
#define WIFI_AP_IP {192, 168, 4, 1}                 // WIFI_AP IP
#define WIFI_AP_NETMASK {255, 255, 255, 0}          // WIFI_AP Маска подсети
#define PASSWORD "123456789"                        // Пароль WIFI_AP and WIFI_STA
#define WIFI_AP_SSID "CactusLampESP32"              // Ssid for WIFI_AP
#define WIFI_STA_SSID "Wi_Fi_Station"               // Ssid for WIFI_STA
#define LAMP_OLWAYS_ON 0                            // Лампа всегда включена? (0 - нет, 1 - да)
#define LAMP_ON_HOUR 8                              // Час включения лампы (0 до 23)
#define LAMP_OFF_HOUR 22                            // Час выключения лампы (0 до 23) 

#define TIMEZONE 3                                  // Временная зона (например UTC 0), hour
#define DAYLIGHTOFFSET 0 * 60 * 60                  // Смещение летнего времени (0 - нет перехода на летнее время)
#define NTP_SERVER "ntp0.ntp-servers.net"           //Сервер времени
#define SDA_PIN 19                                  //SDA пин
#define SCL_PIN 23                                  //SCL пин                            
#define RELAY_LAMP_PIN 22                           //Lamp relay connection pin
#define WEBSERVER_PORT 180                          //Порт Веб-сервера (Web Server)
#define GREETINGS "<h1>ESP32 Cactus Lamp</h1>"      //Сообщение при обращении к http://<IP_ESP32>:WEBSERVER_PORT/
```

Загрузите код в плату ESP32

### Использование

При первоначальный прошивке используются значения по умолчанию, установленные в файле GeneralParameters.h . По умолчанию ESP32 пытается подключиться к точке доступа с ssid WIFI\_STA\_SSID и паролем PASSWORD.  **Внимание: е**сли необходимо подключиться в режиме точки доступа, то необходимо изменить  WIFI\_MODE на WIFI\_AP. IP адрес точки доступа будет WIFI\_AP\_IP и пароль PASSWORD .

После загрузки запускается веб-сервер на порту WEBSERVER\_PORT, который принимает следующие GET запросы :

| Запрос | Результат выполнения запроса | Параметры |
| --- | --- | --- |
| 
```html
http://<ESP32_IP>:WEBSERVER_PORT/
```

 | Вывод приветственной строки | Отсутствуют |
| http://\<ESP32\_IP>:`WEBSERVER_PORT/gettempandhum` | Получение усредненной температуры и влажности | Отсутствуют |
| http://\<ESP32\_IP>:`WEBSERVER_PORT`/settime?hour=0&min=0&sec=0&day=1&month=1&year=2022" | Установка времени RTC ESP32 | Если ESP32 в режиме WIFI\_STA, то  время обновляется с сервера ntp. Если ESP32 в режиме WIFI\_AP, то в параметрах запроса необходимо ввести часы, минуты, секунды, день, месяц, год |
| http://\<ESP32\_IP>:`WEBSERVER_PORT`/gettime | Получение времени RTC ESP32 | Отсутствуют |
| http://\<ESP32\_IP>:`WEBSERVER_PORT`/data | Выводи в формате JSON время, температуру, влажность, начиная с 0 часов | Отсутствуют |
| http://\<ESP32\_IP>:`WEBSERVER_PORT`/setwifistaparam?ssid=MyWiFi&password=12345678 | Установка ssid для режима WIFI\_STA и пароля для режима WIFI\_STA и WIFI\_AP  | ssid - имя точки доступа, password - пароль |
| http://\<ESP32\_IP>:`WEBSERVER_PORT`/setlamptime?on=8&off=22 | Установка времени (в часах) включения и выключения подключенного к реле устройства | on - час включения, off - час отключения |
| http://\<ESP32\_IP>:`WEBSERVER_PORT`/lampalwayson?on=0 | Включено ли подключенное к реле устройство постоянно | on=1 - разрешить работать постоянно постоянно, on=0 - запретить работать постоянно |
| http://\<ESP32\_IP>:`WEBSERVER_PORT/getconfigvalues` | Вывод текущей конфигурации | Отсутствуют |
| http://\<ESP32\_IP>:`WEBSERVER_PORT/`changewifimode?mode=WIFI\_AP | Смена режима работы WIFI ESP32 | mode - либо WIFI\_STA, либо WIFI\_AP |
| http://\<ESP32\_IP>:`WEBSERVER_PORT/rebootdevice` | Перезагрузка ESP32 | Отсутствуют |